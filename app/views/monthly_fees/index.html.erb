<% current_year = Time.zone.today.year %>
<% params[:year].present? ? months = %w[fevereiro marÃ§o abril maio junho julho agosto ] :  months = %w[junho julho agosto]   %>
<%
  statuses = {
    'Paga' => {
      text: 'Paga',
      css_class: 'btn btn-outline-success btn-sm',
    },
    'A pagar' => {
      text: 'Aberto',
      css_class: 'btn btn-outline-secondary btn-sm',
    },
    'Atrasada' => {
      text: 'Atraso',
      css_class: 'btn btn-outline-danger btn-sm',
    },
  }
%>
<%
    color_statuses = {
    'Paga' => { text: 'Paga', style: 'background-color:rgb(138, 233, 138)' },
    'A pagar' => { text: 'A pagar', style: 'color:rgb(37, 37, 37); background-color:rgb(255, 255, 255)' },
    'Atrasada' => { text: 'Atrasada', style: 'background-color:rgb(236, 160, 167)' },
    }
%>
<h1>Mensalidades de 2025</h1>

<%=
        link_to "Ver mensalidades do semestre",
             monthly_fees_path,
            class: 'btn btn-outline-primary mb-2'
    %>
<%=
        link_to "Ver mensalidades do ano",
            monthly_fees_path(year: (current_year)),
            class: 'btn btn-outline-primary mb-2'
    %>
<div>
  <div class="mb-2" data-controller="filter">
    <input
      class="form-control"
      id="myInput"
      type="text"
      placeholder="Digite o nome, email ou telefone do responsÃ¡vel para filtrar..."
      data-filter-target="input"
    />
    
    <table class="fs-9 mb-0 border-top border-translucent table list-group-item">
      <thead>
           
        <tr>
          <th style="width: 27%">Nome</th>
          <% months.each do |month| %>
            <th style="width: 5%; text-align: center;"><%= month %></th>
          <% end %>
        </tr>
     
      </thead>
      <tbody>
        
        <% @students.each do |student| %>
            <tr data-filter-target="row">
                <td style="vertical-align: middle;">
                <strong>
                  <%= link_to student.name, student_path(student), class:'link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover', title:"Ver detalhes do aluno" %>
                </strong> - <%= student.cpf %>
                <p class="font-weight-light mb-0 fs-6 fw-light">
                 
                    <% student.financial_responsibles.each do |responsible| %>
                    <%= responsible.name %> - <%= responsible.cpf %><br>
                    <% end %>
                 
                </p>
                </td>
                <% months.each_with_index do |month, index| %>
                <% date = Date.new(Date.today.year, index + 1, 1) << 1%>
                    <% monthly_fee = student.monthly_fees_by_month[month] %>
                    <% if monthly_fee %>
                        <% color_status = color_statuses[monthly_fee.status] %>
                        <td style="<%= color_status[:style] %>" class="text-center">                            
                            <strong><%= link_to number_to_currency(monthly_fee.calculate_payment_value, unit: ""), student_monthly_fee_path(monthly_fee.student, monthly_fee) %></strong>
                            <p style="white-space: nowrap;" class="mb-1">
                              <%= monthly_fee.status == 'Paga' && monthly_fee.payment_date.present? ? monthly_fee.payment_date.strftime('%d/%m') : monthly_fee.status %>
                            </p>
                            <div class='d-flex justify-content-around'>
                              <%= button_to update_paid_path(items: { id: monthly_fee.id, status: 'Paga' }),
                                            method: :patch,
                                            class: 'btn btn-outline-success btn-sm d-none',
                                            style: "--bs-btn-padding-y: .2rem; --bs-btn-padding-x: .2rem; --bs-btn-font-size: .70rem;" do %>

                                <button type="submit"
                                        data-controller="payment"
                                        data-action="click->payment#mostrarPromptEEnviar"
                                        data-payment-student-id="<%= student.id %>"
                                        data-payment-date="<%= date %>"
                                        data-payment-billing-type-value="<%= monthly_fee.student.current_plan.plan.billing_type %>"
                                        data-payment-monthly-value="<%= monthly_fee.value %>">
                                  <i class="fa-solid fa-circle-check"></i>
                                </button>

                              <% end %>
                                
                            </div>
                        </td>
                    <% else %>
                        <td style="text-align: center; font-size: .75rem; vertical-align: middle; color:rgb(122, 122, 122);">-</td>
                    <% end %>
                <% end %>
            </tr>
        <% end %>

        
      </tbody>
    </table>
  </div>
</div>

